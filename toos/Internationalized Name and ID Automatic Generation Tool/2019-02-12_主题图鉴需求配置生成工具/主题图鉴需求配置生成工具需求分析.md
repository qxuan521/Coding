# 主题图鉴需求配置生成工具
### 基本需求描述

##### 基本定义

物品信息对应表（.csv格式文件，内容为物品的ID与名字的对应关系）、初版输入表（.xls格式文件，内容为各种物品相关的兑换信息,内容存在未填写列需要填写）、完整版输入表（.xls格式文件，内容为各种物品相关的兑换信息，是初版输入表按照原有配置文件以及物品信息对应表填写后的结果)、配置文件（.xml格式，内容为根据完整版输入表按照特定格式生成的配置文件，记录所有兑换物品的信息）。

##### 背景描述

工具主要完成初版输入表的填写，以及配置文件的修改追加，以及兑换属性更改工作，工具由炫舞1策划使用。

产品会根据活动等需要填写初版输入表文件，策划会根据产品提供的初版输入表填写完整版输入表，并根据完整输入表编写xml配置文件，游戏客户端读取新配置文件提供信息（兑换所需的碎片个数，是否有初次兑换优惠等等）完成游戏内的主题屋兑换功能，并将完整输入表交于产品以便其测试功能。

由于工作 重复度高，认为填写容易出现失误，所以开发本工具简化流程降低错误率。

##### 炫舞1中主题屋功能介绍

在游戏存在主题屋功能，主题屋不仅提供消耗一定的碎片能够兑换各类主题屋物品的功能还能通过主题屋中展示的物品用户能够查看物品的获取方式，以及是否有首次兑换优惠，能否碎片兑换等信息。

![使用界面1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\使用界面1.png)

##### ![使用界面2](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\使用界面2.png)![使用界面3](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\使用界面3.png)

##### 功能概述

工具完成三种功能：

1. 完整版输入表填写以及新配置文件生成功能，根据输入到工具的物品信息对应表填写初版输入表中物品的名称，再遍历原配置文件计算填写初版输入表中的ID，填写完整后生成一个完整版输入表，根据生成的完整版输入表的内容将新兑换套装相关信息追加到原配置文件后生成新的配置文件。完整版输入表和新配置文件的输出形式为另存为形式，即创建新的文件。
2. 查询修改配置文件，修改特定字段实现更改物品普通兑换，不可兑换，首次兑换优惠的状态。根据输入ID列表文件（.xls格式文件，内容是需要查询显示的子系列ID的列表），查询配置文件的配置并显示所查结果（ID对应的子系列的兑换相关属性）。使用者通过可视化操作修改物品兑换的状态，工具根据对应状态修改配置文件。不会输出新的文件。
3. 根据配置文件(xml)和“子系列以及母系列""的ID列表文件（.xls格式，内容是子系列的ID以及子系列的母系列的ID列表），输出新的信息（包含道具ID,名称，兑换所需系列碎片，首次兑换优惠所需碎片，等列）文件，文件会采用另存为的形式生成一个新的文件。

### 文件介绍

* 物品信息对应表

  为游戏的国际化名字ID表格，从表格中能根据不同文件的前缀识别方式取出，名字和ID的对应关系。包含三个文件：level_inventory_dress.csv、level_inventory_item.csv、level_inventory_medal.csv，对应前缀为："str_res_dress_name\_"、"str_res_item_name\_"、"str_res_medal_name\_"。经过处理能够得到，物品的名字与ID的对应关系。作为查询的标准文件

  ![图片1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\ID名字对应表.png)

* 初版输入表

  初版输入表，为信息不完整的表格，缺少“系列套装配置”页签中的“子系列”、“兑换所需系列碎片”、“首次兑换优惠所需碎片”、“系列套装部件分数(y)”、“系列套装部件产出途径文本预设及系列碎片产出文本”页签中的“系列碎片获取途径提示”、“产出途径描述”，需要依据物品信息对应表和配置表填写为完整版，如下所示：

  ![初版表格](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\初版_1.png)

  ![初版2](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\初版_2.png)

* 完整输入表

  为根据初版输入表参照物品信息对应表和配置表按照一定规则填写后的表格文件。

  ![完整1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\完整版_1.png)

  ![完整2](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\完整版_2.png)

* 配置文件

  依据完整输入表信息生成的文件，游戏内兑换功能读取相关配置使用。文件全名为clothset_handbook_config.xml，内容如下所示：

  ![配置文件截取1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\配置文件截取_1.png)

  ![配置文件截取2](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\配置文件截取_2.png)

  新配置文件生成问题，原配置文件的字符格式有些特殊，并且不标准（缩进问题、结束多余空格等等问题），经过与用户沟通，工具开发之后大部分修改配置由工具自动生成，但为了方便原使用人员查看习惯以及特殊情况认为修改，对文件采用保持原格式，规范多余空格的方式。个别功能需要重新手动实现。

### 完整版输入表填写以及配置文件生成

初版输入表，为信息不完整的表格，缺少“系列套装配置”页签中的“子系列”、“兑换所需系列碎片”、“首次兑换优惠所需碎片”、“系列套装部件分数(y)”、“系列套装部件产出途径文本预设及系列碎片产出文本”页签中的“系列碎片获取途径提示”、“产出途径描述”，需要依据物品信息对应表和配置表填写为完整版，填写不覆盖初版输入表采用另存为的方式生成。新配置文件则根据新生成的完整输入表以及原配置文件，按照下述规则生成新的配置文件，同样采用另存为的方式生成新的文件不会对原配置文件进行修改。（图示如文件介绍所示）

##### 功能UI及使用流程

![功能流程1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\功能1使用流程UI.png)

* 错误处理，以上显示3个文件路径任意一个为空，会做弹窗提示处理。生成过程中出现错误，会在日志区输出错误，并且在工具路径生成错误文件error.txt。

##### 输出

输出采用另存为的方式，会生成新的完整输入表文件，以及新的配置文件，另存为的路径在生成时弹窗选择。

原配置文件的字符格式有些特殊，工具开发之后大部分修改配置由工具自动生成，但为了方便原使用人员查看习惯以及特殊情况认为修改，对文件采用保持原格式，规范多余空格的方式。个别功能需要重新手动实现。

##### 完整输入表填写规则

“系列套装配置”页签

1. 子系列，读取母系列id，在clothset_handbook_config.xml中该母系列最后一个子id的基础上,顺延一个新的子系列id填入，例如母系列为400000，配置中最后一个子id为400008，则新的子id为400009

2. 道具名称，读取国际化路径下的物品信息对应表文件，根据初版需求表中所给的道具ID，分别生成对应的男女道具名称。

3. 兑换所需系列碎片，读取市场参考价，按照公式“市场参考价*0.75”得出“兑换所需系列碎片”,“兑换所需系列碎片”为整数（四舍五入）。

4. 首次兑换优惠所需碎片，读取市场参考价，按照公式“市场参考价*0.6”得出“首次兑换优惠所需碎片”，“首次兑换优惠所需碎片”为整数（四舍五入）

5. 系列套装部件分数(y)，读取市场参考价，按照公式“市场参考价*0.1”得出“系列套装部件分数(y)”， “系列套装部件分数(y)”为整数（四舍五入）

“系列套装部件产出途径文本预设及系列碎片产出文本”页签

1. 系列碎片获取途径提示,读取clothset_handbook_config.xml中<PieceObtainText\>字段最后一个字段中的数字,在这个数字的基础上顺延一个新数字 ,“碎片获取途径” + 新数字填入表格中。

![填写图1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\填写辅助_1.png)

2. 产出途径描述，读取clothset_handbook_config.xml中<ClothsetObtainText\>字段最后一个字段中的数字,在这个数字的基础上顺延一个新数字填入表格中。

![辅助图2](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\填写辅助_2.png)

##### 新配置文件生成规则

1. 系列碎片获得途径提示，读取完整输入表中--“系列套装部件产出途径文本预设及系列碎片产出文本”页签（表格形式如文件介绍所示），在clothset_handbook_config.xml（配置文件）件中的<PieceObtainText\>字段末尾处生成对应的字段。
   * 配置中的context="X"，X对应表格中的文本文字。
   * 配置中的\<!--X--\>，X对应表格中碎片获取途径后的数字。

* 错误处理及检查

  在生成以上字段之前，需要检测在\<PieceObtainText>中是否有重复的碎片获取途径数字，即\<!--X-->中的X是否重复, 若重复则生成检错txt文档（error.txt，在工具当前路径），文档中列出重复的数字，并在日志区输出。

* 输出结果图示，

![配置文件1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\配置文件填写辅助1.png)



2. 产出途径描述，读取完整输入表中--“系列套装部件产出途径文本预设及系列碎片产出文本”页签（表格形式如文件介绍所示），在clothset_handbook_config.xml文件（配置文件）中的\<ClothsetObtainText>字段末尾处生成对应的字段。
   * 配置中的obtain_id="X"，X对应表格中的数字。
   * 配置中的context="XXXX"，X对应表格中的文本文字。

* 错误处理及检查

  在生成以上字段之前，需要检测在\<ClothsetObtainText>字段中是否有重复的部件获取途径数字，即obtain_id="X"中的X是否重复，若重复则生成检错txt文档（error.txt,在工具当前路径），文档中列出重复的数字，并在日志区输出。

* 输出结果图示，

![配置文件1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\配置文件填写辅助2.png)

3. 系列套装配置，读取完整输入表中--“系列套装配置”页签（表格形式如文件介绍所示），在clothset_handbook_config.xml文件(配置文件)中最后一个\</Clothset>节点后生成对应的\<Clothset>配置字段。

   * 配置表中的series_id="X"，X对应表格中的母系列i。
   * 配置表中的set_id="X"，X对应表格中的子系列id。
   * 配置表中的set_name="XXXX"，对应表格中的系列名称。
   * 配置表中的cover="XXXX"，对应主题图鉴美术切图字符，需要手动在编辑器内输入添加。
   * 配置表中的score_factor="X"，X对应表格中的得分系数（X）
   * 配置表中的complete_score="X"，X对应表格中的收集完成额外分数基数(z)
   * 配置表中的on_shelf_time="XXXX"，对应表格中的上架时间，默认不添加offer_enable ="1"字段，即默认为不开启首次兑换优惠。

   系列套装内存在多个单个道具字段，每个道具在对应一个\<Part>字段，是\<Clothset>的子节点。

   * 配置中的male_id="X"，X对应表格中的道具ID（默认）。
   * 配置中的female_id="X"，X对应表格中的道具ID（女）。
   * 配置中的cost="X"，X对应表格中的兑换所需系列碎片，当需求中对应单元格文字为空或文字为“暂不支持兑换”时，cost="X"中的X为“-1”。
   * 配置中的score="X"，X对应表格中的系列套装部件分数(y)
   * 配置中的 \<!-- XXXX -->，XXXX对应表格中的道具名称（默认）和道具名称（女），当需求中道具名称男女一致时，XXXX只生成一个即可，当需求中道具名称男女不一致时，XXXX需要将男女道具名称一同生成到字段中，用“/”分隔，例如\<!--棋魂· 棋艺/棋魂·棋魂 -->。
   * 配置中的首个 \<Obtain id="1"/>为固定配置，第二个\<Obtain id="X"/>字段中的Obtain id="X"，对应当前系列的产出途径描述对应的id数字。

* 错误处理及检查

  无

* 输出结果图示，

  ![配置文件4](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\配置文件截取_3.png)

4. 额外奖励配置，l 读取完整版输入文件中--“额外奖励配置”页签，如果当前也签下第二行时空则不生成配置，在clothset_handbook_config.xml文件中最后一个\</ExtraRewards>节点后生成对应的配置字段。

   * 配置中的rewards_id="X"，X需要根据当前导入的xml配置中的最后一个rewards_id来顺延，例如最后一个id为106，则生成的id为107

   * 配置中的set_id="X"，X对应“系列套装配置”页签中对应系列的子系列id

   * 配置中的type="X"，X对应表格中的奖励1type，取数字部分

   * 配置中的para1="X"，X对应表格中的奖励1ID（男）

   * 配置中的para2="X"，X对应表格中的奖励1ID（女）

   * 配置中的para3="X"，X对应表格中的奖励1时效,若时效为永久，则X为0,若时效为A天/B个，则X为A/B

* 错误处理及检查

* 输出结果图示

  ![配置文件4](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\配置文件截取_4.png)

### 查询修改配置文件

配置文件需要能够更改指定系列套装物品的兑换属性（普通兑换，不可兑换，首次兑换优惠），所以工具根据输入的查询列表显示查询结果，并提供能够更改当前兑换属性的开关方便更改。

查询列表文件为.csv文件，无表头，第一个也签(sheet1)第一列为有效数据，是子系列ID的列表，结束标志为任意一行为空。第二列为不存在优惠兑换的物品的ID（part字段中有可能对应两个性别的ID其中任意一个匹配则认为当前字段没有首次优惠），即当将子系列更改成首次优惠兑换开启的模式时，不存在兑换的物品将不添加offer_cost属性，查询列表文件格式如下图

![输入列表1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\输入列表1.png)



##### 功能UI及使用流程

![功能流程1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\功能2UI.png)

* 错误处理，以上显示两个文件路径不选择，均弹窗提示错误。表格为空时点击确认修改，会弹出对话框提示表格为空。
* 使用约束，路径选择完成之后需要先点击查询，每次修改之后会把表格清空，需要重新查询。查询结果，出现结果修改属性之后点击确认修改才保存。

* 控件功能介绍，搜索框会对查询结果的表格进行搜索帮助快速定位，如果存在高亮显示，如果不存在弹窗提示未找到。一键更改功能按钮，将所有查询内容更改成统一个选项。

##### 输出

使用另存为的方式输出新的配置文件。

原配置文件的字符格式有些特殊，工具开发之后大部分修改配置由工具自动生成，但为了方便原使用人员查看习惯以及特殊情况认为修改，对文件采用保持原格式，规范多余空格的方式。个别功能需要重新手动实现。

##### 配置文件修改规则

两个路径选择完成之后，点击查询会对配置文件的字段名为Clothset的字段进行遍历比对，根据配置文件所存储的状态标记选项按钮（关闭兑换:part字段的cost属性为“-1“并且不存在 offer_cost = ”xxx“，子系列字段中不存在offer_enable = ”1“，首次兑换优惠：Clothset字段存在offer_enable = "1"part字段的cost属性不是“-1”，普通兑换：Clothset字段不存在offer_enable = "1"part字段的cost属性不是“-1”）,点击确认修改，保存修改结果并清空列表。

！注意，对已经关闭兑换的字段进行修改时需要根据“分数（score属性）*7.5“（四舍五入取整）的公式计算出cost属性的值填写进去。优惠兑换碎片数（offer_cost字段）的数值等于 ：分数（score属性）\*6。

### 根据配置文件生成物品兑换信息表

通过导入母系列id+子系列id+xml配置文件，导出完整的历史图鉴需求xls文档

母系列id+子系列id文件为csv格式表格文件，格式如下，

![母系ID子系ID](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\母系ID子系ID列表.png)

无表头，第一个页签（sheet1）第一列为母析ID，第二列为子系ID,结束标志为任意一行的任意一列为空则视为结束。

##### 功能UI及使用流程

![功能3](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\功能3.png)

* 错误处理，以上所示两个路径如有任意一个没有选择的情况，点击导出会弹窗提示用户选择路径。对于ID列表中无法找到的行，会在日志区进行输出。
* 使用约束，ID列表文件不验证第一个页签第一第二列以外的数据，中间出现任意空行无论那一列为空均视为列表结束。

##### 输出

使用另存为的方式输出新的xls文件，其中包括下示表格。

![输出1](E:\需求分析\2019-02-12_主题图鉴需求配置生成工具\输出历史配置.png)

##### 填写规则

按照功能1生成配置文件的方式，进行逆向功能生成完整输入表格的系列套装配置页签的内容。